# DP100 Power Supplier USB Protocol Reverse 

Engineering Device: Zhengdian Atom DP100

Protocol Reverse Engineering.

I primarily use macOS, with Linux as a secondary system, and rarely use Windows. 
Since Zhengdian Atom only provides .NET DLLs for the Windows platform, secondary development is extremely inconvenient. 
Therefore, I plan to reverse engineer the underlying communication protocol to see how it is implemented, 
and then use other languages for porting. 

## Protocol Analysis 

### USB enumeration information uses the HID protocol. Although not HID, it is a HID Class. 

``` 
ID 2e3c:af01 
    Configure:0, Interface:0, Setting:0 
        Endpoint: Address: 81, Direction: IN, Transfer Type: Interrupt 
        Endpoint: Address: 01, Direction: OUT, Transfer Type: Interrupt 
``` 

### USB Transfer Items 

| Item | Value | Remarks | 
| ---------------------- | -------- | ------------------------------------------------------------ | 
| USB Class | 0x03 HID | Direct data transfer without usage | 
| HID usage | None | Version 1.1 includes a 64-byte application, the purpose of which is unclear.<br> 1.2 Directly deleted |
| USB Packet Data Length | Fixed 64 | If the package length is less than 64, padding with 0s is allowed, or it can be ignored | 

### Transmission Protocol 

| Item | Value | | 
| ---------- | ---- | ---- | 
| Endianness | Little Endian | | 

### Package Layout 

| Byte | 0 | 1 | 2 | 3 | ... | len+4 | len+5 |
| ---- | -------- | ------ | ------- | ---- | --------- | ----- | ----- | 
| Meaning | Transmission Direction | OpCode | Reserve | Len | Len data | crc16 | crc16 | 
| Description | fa/fb | Operation | 00 | | | LOW | HIGH | Example `fb300000310f00000000000000000000000000000000000000000000000000000000000000000...` | 

#### Transmission direction

Host transmits to Device (`0xfb`), 
Device transmits to Host (`0xfa`) 

#### OpCode 

| OpCode | Description | | 
| ------ | ----------- | ---- | 
| 0x10 | DEVICE_INFO | | 
| 0x12 | START_TRANS | | 
| 0x13 | DATA_TRANS | | 
| 0x14 | END_TRANS | | 
| 0x15 | DEV_UPGRADE | | 
| 0x30 | BASIC_INFO | | 
| 0x35 | BASIC_SET | | 
| 0x40 | SYSTEM_INFO | |
| 0x45 | SYSTEM_SET | | 
| 0x50 | SCAN_OUT | | 
| 0x55 | SERIAL_OUT | | 
| 0x80 | DISCONNECT | | 

The usage of each OpCode will be explained in the following chapters. 

#### Len 

The literal meaning is the length of the data that follows. 
How to determine this depends on the OpCode. 

#### Data 

The actual data content carried. The meaning varies depending on the OpCode, as explained below. 

#### CRC 

E2E verification method CRC-16/MODBUS. The Payload is from the first byte to the end of Data. 
Note that it is little-endian; that is, if calculated as 1234, the transmission should be changed to 0x34 0x12.

### Timing 

```mermaid 
sequenceDiagram 
    participant Host 
    participant Device 
    Host->> Device:USB enumeration etc. 
    Device->>-Host:- 

    Host->> Device:Interrupt Out:fb300000310f.. 
    Device->>-Host:Interrupt In: fa3000xxxxxxxx.. 
``` 

## OpCode 

The following information is from the dll dump. 
**!! !! Untested and unverified!! !! **Please examine the content with a critical eye. 

### 0x10 DEVICE_INFO 

Host sends Len = 0 
Device sends data as follows: 
| Name | Type | | 
| -------- | --------- | ---- | 
| dev type | uint8[16] | | 
| hdw_ver | uint16 | origin:11 means 1.1 | 
| app_ver | uint16 | origin:11 means 1.2 | 
| boot_ver | uint16 | | 
| run_area | uint16 | | 
| dev_sn | uint8[12] | | 
| year | uint16 | | 
| moon | uint8 | | 
| day | uint8 | | 

### 0x12 START_TRANS 

Untested, probably Host sends Len = 0 
Device sends Len = 0 

### 0x13 DATA_TRANS 

Unknown 

### 0x14 END_TRANS 

Untested, but it's likely that the 
Host sends Len = 0 and the Device sends Len = 0. 

### 0x15 DEV_UPGRADE is unknown. 

I couldn't find any relevant information in simple Decompile, and it's not my focus, so I didn't investigate it further. 

### 0x30 BASIC_INFO 

Host Send Len = 0 
Device Send 
| Name | Type | | 
|----|--|--| 
| vin | uint16 | | 
| vout | uint16 | | 
| iout |uint16 | | 
| vo_max | uint16 | | 
| temp1 |uint16 | | 
| temp2 |int16 | | 
| dc 5V |uint16 | | 
| out mode |uint8 | This enumeration value is not tested | 
| work st | uint8 | This enumeration value is not tested | 

### 0x35 BASIC_SET 

This is not set basic info. There is a list of `Basic Set`, 10 sets are stored in device. 

#### Query Host 

sending len = 1 

| Name | Type | |
| ------- | ------ | ---- | 
| index | uint8 | |

 to query the `Basic Set`, the device responses. 
 The higher 4 bits of index is flags,seems defined as below index=80,to query activated one
 
 #### Set `Basic Set` has a structure below 
 
 | Name | Type | |
 | ------- | ------ | ---- | 
 | index | uint8 | | 
 | state | uint8 | 0=off<br/> 1=on | 
 | vo_set | uint16 | | 
 | io_set | uint16 | | 
 | ovp_set | uint16 | | 
 | ocp_set | int16 | `Basic Set` |. 
 
 The Device reply as 
 
 | Name | Type | |
 | ------- | ------ | ---- | 
 | result | uint8 | 1 = ok | 
 
 ### 0Ã—40 SYSTEM_INFO 
 
 Host sent Len = 0 
 Device sent 

| Name | Type | |
| ------- | ------ | ---- |
| blk_lev | int8   |  backlight    |
| opp     | uint16 |  over power    |
| opt     | uint16 |  over temperature    |
| vol_lev | int8   |  beep volumn    |
 
 ### 0x45 SYSTEM_SET 
 
 Unknown 
 
 ### 0x50 SCAN_OUT 
 
 Host Send 
 
 | Name | Type | |
 | --------- | -------- | ----- | 
 | on_off | ?1 byte? | | 
 | on_time | uint16 | | 
 | out_val | uint16 | | 
 | scan_mode | ?1 byte? | I / V | 
 | start | uint16 | | 
 | end | uint16 | | 
 | step | uint16 | | 
 
 Device Send Untested 
 
 ### 0x55 SERIAL_OUT 
 
 I don't quite understand this function. 
 Someone can explain it later with a reference to the UI. 
 This is not the target of this project. 
 Host sends 
 
 | Name | Type | | 
 | ----------- | ------ | ---- | 
 | on_off | uint8 | | 
 | on_time | uint16 | | 
 | ser_start | uint8 | | 
 | ser_end | uint8 | | 
 | ser_vi | uint16 | | 
 | ser_vo | uint16 | | 
 | cycle_times | uint8 | 
 
 Device sends untested 
 
 ### 0x80 DISCONNECT 
 
 Untested, likely 
 Host sends Len = 0 
 Device sends Len = 0